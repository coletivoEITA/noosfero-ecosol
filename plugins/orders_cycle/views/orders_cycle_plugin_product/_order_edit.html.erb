<% editable = order && order.may_edit?(@admin_action) %>
<% draft_order = cycle.orders.draft.for_consumer(user).first %>
<% include_message = '' %>
<% if order.nil? %>
  <% if draft_order %>
    <% order_id = draft_order.id %>
    <% include_message = t('orders_cycle_plugin.views.product._order_edit.opening_order_code_fo') % {:code => draft_order.code} %>
  <% else %>
    <% order_id = 'new' %>
    <% include_message = t('orders_cycle_plugin.views.product._order_edit.opening_new_order_for') %>
  <% end %>
<% else %>
  <% order_id = order.id %>
<% end %>

<div class="box-view with-inner">
  <% if editable %>
    <div class="box-field select toggle-ignore"><%= check_box_tag "products_ids[]", product.id %></div>
  <% end %>

  <div class="box-view-inner">
    <div class="box-field category"><%= product.category_name %></div>
    <div class="box-field supplier"><%= product.supplier.abbreviation_or_name %></div>
    <div class="box-field product box-edit-link"><%= product.name %></div>
    <div class="box-field price-with-unit"><%= price_with_unit_span product.price_as_currency_number, product.unit, product.unit_detail %></div>

    <div class="box-field quantity">
      <div class="quantity-label">
        <% if ordered_product %>
          <span class="label"><%= ordered_product.quantity_asked_as_currency_number %></span>
          <span class="unit"><%= product.unit.singular %></span>
          <%= link_to_function t('orders_cycle_plugin.views.product._order_edit.change'), "" if editable %>
        <% elsif cycle.orders? %>
          <%= link_to_function t('orders_cycle_plugin.views.product._order_edit.include'), "" %>
        <% end %>
      </div>
      <div class="quantity-entry" style="display: none">
        <% if cycle.orders? %>
          <%= text_field_tag 'quantity_asked', ordered_product ? ordered_product.quantity_asked_as_currency_number : '1,00' %>
        <% elsif ordered_product %>
          <%= ordered_product.quantity_asked_as_currency_number %>
        <% end %>
      </div>
    </div>

    <div class="clean"></div>
  </div>
</div>

<div class="box-edit subtitle">
  <div class="box-field product-info">
    <div>
      <div class="box-field product product-desc">
        <%= product.description.blank? ? t('orders_cycle_plugin.views.product._order_edit.no_description') : excerpt_ending(product.description, 250) %>
      </div>

      <div class="box-field price-with-unit">
        <div><%= t('orders_cycle_plugin.views.product._order_edit.price_s_descriptive') %></div>
        <div class="price-descriptive">
          <%= t('orders_cycle_plugin.views.product._order_edit.price_percent_price_w') % {
            :price => product.buy_price_as_currency,
            :percent => product.margin_percentage,
            :price_with_margin => product.price_as_currency, } %>
        </div>
      </div>
    </div>

    <div>
      <% if product.supplier.profile.city %>
        <div class="product-city">
          <span class="field-title"><%= t('orders_cycle_plugin.views.product._order_edit.city') %></span>
          <span><%= t('orders_cycle_plugin.views.product._order_edit.city_state') % {:city => product.supplier.profile.city, :state => product.supplier.profile.state} %></span>
        </div>
      <% end %>

    </div>

    <div class="product-supplier-link">
      <% unless product.supplier_dummy? %>
        <%= link_to t('orders_cycle_plugin.views.product._order_edit.more_about_the_produc') % {:supplier => product.supplier.abbreviation_or_name}, product.supplier.profile.url, :target => '_blank' %>
      <% end %>
    </div>
  </div>

  <div class="box-field quantity">
    <% product.unit_detail.blank? ? detail = "" : detail = " (#{product.unit_detail})"%>
    <span class="unit"><%= product.unit.singular + detail %></span>

    <% if false # by now, it has no way to submit images %>
      <div class="product-image">
        <%= t('orders_cycle_plugin.views.product._order_edit.product_image'); %>
      </div>
    <% end %>

    <% if cycle.orders? %>
      <%# FIXME: put js in a function of orders_cycle.js %>
      <%= submit_to_function (ordered_product ? t('orders_cycle_plugin.views.product._order_edit.change') : t('orders_cycle_plugin.views.product._order_edit.add')),
        "loading_overlay.show('#cycle-product-#{product.id}'); " +
        "orders_cycle.order_product.include('#{include_message}'); " +
        "jQuery.post('#{url_for(:controller => :orders_cycle_plugin_ordered_product, :action => :new)}', {order_id: '#{order_id}', redirect: '#{order.nil? ? '1' : ''}', offered_product_id: #{product.id}, quantity_asked: jQuery(this).parents('.order-cycle-product').find('.quantity-entry input').val() }); " %>
    <%= link_to_function t('orders_cycle_plugin.views.product._order_edit.cancel'), :class => 'toggle-edit' %>
  <% end %>
</div>

<div class="clean"></div>
</div>

<% javascript_tag do %>
  jQuery("#cycle-product-<%=product.id%>").toggleClass('in-order', <%= !ordered_product.blank? %>);
<% end %>

<div class="clean"></div>

